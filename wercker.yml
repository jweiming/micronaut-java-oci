# This references an OpenJDK container from the
# Docker Hub https://hub.docker.com/_/openjdk/
# Read more about containers on our dev center
# https://devcenter.wercker.com/overview-and-core-concepts/containers/
box: gradle:5.5.1-jdk11
# This is the build pipeline. Pipelines are the core of wercker
# Read more about pipelines on our dev center
# https://devcenter.wercker.com/development/pipelines/

build:
  # Steps make up the actions in your pipeline
  # Read more about steps on our dev center:
  # https://devcenter.wercker.com/development/steps/
  steps:
    - java/gradle:
      task: build
      cache_project_cache: true

    - internal/docker-build:
        context: ./
        image-name: hello-world

    # push as commit-id tag
    - internal/docker-push:
        username: $USERNAME
        password: $PASSWORD
        image-name: hello-world
        tag: ${WERCKER_GIT_COMMIT}
        repository: oardc1/joseph.che
        registry: https://iad.ocir.io/v2

    # push as latest tag
    - internal/docker-push:
        username: $USERNAME
        password: $PASSWORD
        image-name: hello-world
        tag: latest
        repository: oardc1/joseph.che
        registry: https://iad.ocir.io/v2

deploy-to-oke:
  box: oracle/graalvm-ce:19.0.0

  steps:

    - script:
        name: debug
        code: |
          echo $WERCKER_OUTPUT_DIR
          ls -l $WERCKER_OUTPUT_DIR
          echo $WERCKER_ROOT
          ls -l $WERCKER_ROOT
    - bash-template:
        cwd: $WERCKER_ROOT/oke

    - script:
        name: Remove template files
        cwd: $WERCKER_ROOT/oke
        code: |
          rm *.template.yaml
    - script:
        name: debug
        cwd: $WERCKER_ROOT/oke
        code: |
          ls -l
    - script:
        name: echo tags
        code: |
          chmod 777 $WERCKER_ROOT/oke/oke_service.yaml
          chmod 777 $WERCKER_ROOT/oke/oke_deployment.yaml
          echo "Docker image and tag:"
          echo "${WERCKER_GIT_BRANCH}-${WERCKER_GIT_COMMIT}"
    - wercker/kubectl@3.14.0:
        debug: true
        server: $OKE_MASTER
        token: $OKE_TOKEN
        cwd: $WERCKER_ROOT/oke/
        insecure-skip-tls-verify: true
        command: apply -f .

    - wercker/kubectl@3.14.0:
        name: set deployment timeout
        server: $OKE_MASTER
        token: $OKE_TOKEN
        insecure-skip-tls-verify: true
        command: patch deployment/mn-graalvm-app -p '{"spec":{"progressDeadlineSeconds":600}}'
